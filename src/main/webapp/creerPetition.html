<!DOCTYPE html>
<html>
<head>
	<meta name="google-signin-scope" content="profile email">
	<meta name="google-signin-client_id" content="232742472331-2f32mq8k3pbenacl44usnrf37362vo4t.apps.googleusercontent.com">
	<script src="https://apis.google.com/js/platform.js"async defer></script>
	<title>Créer pétition</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
	<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
	<script src="https://unpkg.com/mithril/mithril.js"></script>
</head>

<body>
<script>

const mail = localStorage.getItem("Email");
const name = localStorage.getItem("Name");

var CreatePetView = {
	petName:"",
	petProbleme:"",
	view: function() {
		return m("form", {
			onsubmit: function(e) {
				e.preventDefault()
				CreatePet.postPet()
			}},
		[
			m('div', {class:'field'},[
				m("label", {class:'label'},"Nom de la pétition"),
				m('div',{class:'control'}, m("input[type=text]", {
					class:'input is-rounded',
					placeholder:"Votre nom de pétition",
					required:"required",
					oninput: function(e) {CreatePetView.petName = e.target.value}
				})),
			]),
			m('div',{class:'field'},[
				m("label", {class: 'label'},"Problème"),
				m('div',{class:'control'},m("input[type=textarea]", {
					class:'textarea',
					required:"required",
					placeholder:"Votre problème",
					oninput: function(e) { CreatePetView.petProbleme = e.target.value }
				})),
			]),
			m('div',{class:'control'},
				m('label',{class:'checkbox'},
				m("input", {type:'checkbox', required:"required"}), "Les informations saisies sont correctes et respectueuses")
			),
			m('div',{class:'control'},
				m("button[type=reset]", {class:'button is-warning'},
				m("icon", {class:"fas fa-eraser"}), "Effacer"),
				m("button[type=submit]", {class:'button is-success'},
				m("icon", {class:"fas fa-check"}), "Envoyer")
			),
		])
	}
}

function signOut() {
	var auth2 = gapi.auth2.getAuthInstance();
	auth2.signOut().then(function () {
		console.log('User signed out.');
		localStorage.clear();
		window.location.href="index.html";
	});
}

var CreatePet = {
	postPet: function() {
		var data={'owner': mail,
			'petName':CreatePetView.petName,
			'petProbleme':CreatePetView.petProbleme}
		console.log("post:"+data)
		return m.request({
			method: "POST",
			url: "_ah/api/myApi/v1/creerpetition",
			params: data,
		})
		.then(function(result) {
			console.log("got:",result)
			document.location.href="/petCree.html"
		})
	}
}

var Hello = {
	view: function() {
		if(localStorage.getItem("Email") != null){
			return m('div', {class:'container'}, [
				m('nav',{class: 'navbar is-fixed-top'},[
					m('div',{class: 'navbar-start'},[
						m('img', {src:"/logo.png"}),
						m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/index.html";}},
							m("icon", {class:"fas fa-chart-line"}), "Top pétition"),
						m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/creerPetition.html";}}, 
							m("icon", {class:"fas fa-pen"}), "Créer pétition"),
						m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/petCree.html";}}, 
							m("icon", {class:"fas fa-user"}), "Mes pet créées"),
						m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/petSignee.html";}}, 
							m("icon", {class:"fas fa-user"}), "Mes pet signées"),  			
					]),
					m('div',{class: 'navbar-end'},[
						m('h1', {class: 'title is-ancestor'}, name),
						m("div", {
							"style": "display:none",
							"class":"g-signin2",
							"data-theme":"dark",
							"data-onsuccess": "onSignIn"}),	
						m('button', {class:"button is-danger is-rounded", onclick: function(e) { signOut();}},
							m("icon", {class:"fas fa-sign-out-alt"}), "Déconnexion"),						   
					]),
				]),
				m("h1", {class: 'title is-ancestor'}, 'Création d\'une pétition'),
				m("h1", {class: 'title is-ancestor'}, 'Création d\'une pétition'),
				m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(CreatePetView))),
				m("footer", {class: 'has-text-centered'}, "Site réalisé par Luca GARIC et Michaël LOPES - V1.0"),
			])
		} else {
			document.location.href="/index.html";		
		}
	}
}

m.mount(document.body, Hello)
</script>
</body>
</html>