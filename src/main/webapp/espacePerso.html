<!DOCTYPE html>
<html>
<head>
	<meta name="google-signin-scope" content="profile email">
	<meta name="google-signin-client_id" content="232742472331-2f32mq8k3pbenacl44usnrf37362vo4t.apps.googleusercontent.com">
	<script src="https://apis.google.com/js/platform.js"async defer></script>
	<meta charset="UTF-8">
	<title>Espace personnel</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
	<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
	<script src="https://unpkg.com/mithril/mithril.js"></script>
</head>

<body>
<script>

const mail = localStorage.getItem("Email");
const name = localStorage.getItem("Name");

var MyPetSigned = {
	list: [],
	nextToken: "",
	loadList: function() {
		return m.request({
			method: "GET",
			url: "_ah/api/myApi/v1/signedpet/"+mail
		})
		.then(function(result) {
			MyPetSigned.list = result.items
			if ('nextPageToken' in result) {
	        	MyPetSigned.nextToken= result.nextPageToken
	        } else {
	        	MyPetSigned.nextToken=""
        	}
			console.log("got:",name)
		})
	},
	next: function() {
	    return m.request({
	        method: "GET",
	        url: "_ah/api/myApi/v1/signedpet/"+mail+"?next="+MyPetSigned.nextToken})
	    .then(function(result) {
	    	console.log("got:",result)
	    	result.items.map(function(item){MyPetSigned.list.push(item)})
	        if ('nextPageToken' in result) {
	        	MyPetSigned.nextToken= result.nextPageToken
	        } else {
	        	MyPetSigned.nextToken=""
        }})
	}
}

function troncatstring(item){
	var troncstring = {}
	if(item.properties.probleme.length > 30){
		troncstring = item.properties.probleme.substring(0,30)+"..."
	} else {
		troncstring = item.properties.probleme
	}
	return troncstring
}

var MyPetSignedView = {
	oninit: MyPetSigned.loadList,
	view: function() {		
		return m('div', [
			m('div',{class:'subtitle'},"Mes petitions signées"),
			m('table', {class:'table is-striped'},[
				m('tr', [
					m('th', {width:"25%"}, "Titre"),
					m('th', {width:"15%"}, "Date de création"),
					m('th', {width:"40%"}, "Probleme"),
					m('th', {width:"10%"}, "Signatures"),
					m('th', {width:"10%"}, "Détails"),
				]),
				MyPetSigned.list.map(function(item) {
					return m("tr", [
						m('td', m('label', item.properties.titre)),
						m('td', m('label', item.properties.dateC)),
						m('td', m('label', troncatstring(item))),
						m('td', m('label', item.properties.nbSignature)),
						m('button', {class:"button is-primary is-rounded is-small", onclick: function(e) { document.location.href="/detailsPet.html?idpet="+item.key.name;}}, "Voir plus"),
					])
				}),
				m('button',{
					class: 'button is-link',
					onclick: function(e) {MyPetSigned.next()}
				}, "Suivant"),
			])
		])
	}
}

function signOut() {
	var auth2 = gapi.auth2.getAuthInstance();
	auth2.signOut().then(function () {
		console.log('User signed out.');
		localStorage.clear();
		window.location.href="index.html";
	});
}

var MyPetCreated = {
	list: [],
	nextToken: "",
	loadList: function() {
		return m.request({
			method: "GET",
			url: "_ah/api/myApi/v1/mycreatedpet/"+mail
		})
		.then(function(result) {
			MyPetCreated.list = result.items
			if ('nextPageToken' in result) {
	        	MyPetSigned.nextToken= result.nextPageToken
	        } else {
	        	MyPetSigned.nextToken=""
	    	}
		})
	},
	next: function() {
		return m.request({
			method: "GET",
			url: "_ah/api/myApi/v1/mycreatedpet/"+mail+"?next="+MyPetCreated.nextToken})
		.then(function(result) {
			console.log("got:",result)
			result.items.map(function(item){MyPetCreated.list.push(item)})
			if ('nextPageToken' in result) {
				MyPetCreated.nextToken= result.nextPageToken
			} else {
				MyPetCreated.nextToken=""
			}
		})
	}
}

var MyPetCreatedView = {
	oninit: MyPetCreated.loadList,
	view: function() {
	return m('div', [
		m('div',{class:'subtitle'},"Mes petitions créées"),
		m('table', {class:'table is-striped'},[
			m('tr', [
				m('th', {width:"25%"}, "Titre"),
				m('th', {width:"15%"}, "Date de création"),
				m('th', {width:"30%"}, "Probleme"),
				m('th', {width:"10%"}, "Signatures"),
				m('th', {width:"10%"}, "Etat"),
				m('th', {width:"10%"}, "Détails"),
				]),
				
				MyPetCreated.list.map(function(item) {
					return m("tr", [
						m('td', m('label', item.properties.titre)),
						m('td', m('label', item.properties.dateC)),
						m('td', m('label', troncatstring(item))),
						m('td', m('label', item.properties.nbSignature)),
						m('td', m('label', item.properties.etat)),
						m('button', {class:"button is-primary is-rounded is-small", onclick: function(e) { document.location.href="/detailsPet.html?idpet="+item.key.name;}}, "Voir plus"),
					])
				}),
				m('button',{
					class: 'button is-link',
					onclick: function(e) {MyPetCreated.next()}
				}, "Suivant"),
			])
		])
	}
}

var Hello = {
	view: function(){
		if(localStorage.getItem("Email") != null) {
			return m('div', {class:'container'}, [
				m('nav',{class: 'navbar is-fixed-top'},[
					m('div',{class: 'navbar-start'},[
						m('img', {src:"/logo.png"}),
						m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/index.html";}},
						m("icon", {class:"fas fa-chart-line"}), "Top Pétition"),
						m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/creerPetition.html";}}, 
						m("icon", {class:"fas fa-pen"}), "Créer pétition"),
						m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/espacePerso.html";}}, 
						m("icon", {class:"fas fa-user"}), "Espace perso"),
					]),
					m('div',{class: 'navbar-end'},[
						m('h1', {class: 'title is-ancestor'}, name),
						m("div", {
							"style": "display:none",
							"class":"g-signin2",
							"data-theme":"dark",
							"data-onsuccess": "onSignIn"}),
						m('button', {class:"button is-danger is-rounded", onclick: function(e) { signOut();}},
						m("icon", {class:"fas fa-sign-out-alt"}), "Deconnexion"),
					]),
				]),
				m("h1", {class: 'title'}, 'Mon Espace Personnel'),
				m("h1", {class: 'title'}, 'Mon Espace Personnel'),
				m('div',{class: 'navbar-end is-ancestor'},[
					m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(MyPetSignedView))),
					m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(MyPetCreatedView))),
				]),
				m("footer", {class: 'has-text-centered'}, "Site réalisé par Luca GARIC et Michaël LOPES - V1.0"),
			])
		}else{
			document.location.href="/index.html";
		}
	}
}

m.mount(document.body, Hello)
</script>
</body>
</html>