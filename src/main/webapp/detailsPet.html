<!DOCTYPE html>
<html>
<head>
<meta name="google-signin-scope" content="profile email">
<meta name="google-signin-client_id" content="46330245209-9jejvn58229dabq46josvavn3crj9ogl.apps.googleusercontent.com">
<script src="https://apis.google.com/js/platform.js"async defer></script>
<meta charset="utf-8">
<title>Top petitions</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script src="https://unpkg.com/mithril/mithril.js"></script>

</head>
<body>

<script>

var currenturl = document.location.href
var idobj = currenturl.split('?')[1]
var idurl = "_ah/api/myApi/v1/detailpet/"+idobj
var idsignerpeturl = "_ah/api/myApi/v1/signerpet/"+idobj
var idfermerpeturl = "_ah/api/myApi/v1/fermerpet/"+idobj
var Profile={
		  name:"",
		  email:"",
		  ID:"",
}

var DetailsPet = {
	list: [],   
	loadList: function(idobj) {
		return m.request({
			method: "GET", 
			url: idurl
		})
		.then(function(result) {
			DetailsPet.list = result.items
			console.log("got:",result.items)
			// m.redraw(true) 
		})
	}
}

var SignerPet = {
	list: [],   
	loadList: function(idobj) {
		return m.request({
			method: "GET", 
			url: idsignerpeturl
		})
		.then(function(result) {
			DetailsPet.list = result.items
			console.log("got:",result.items)
			DetailsPet.loadList()
			// m.redraw(true) 
		})
	}
}

var FermerPet = {
	list: [],   
	loadList: function(idobj) {
		return m.request({
			method: "GET", 
			url: idfermerpeturl
        })
        .then(function(result) {
            DetailsPet.list = result.items
        	console.log("got:",result.items)
        	DetailsPet.loadList()
        	// m.redraw(true) 
        })
    }
}

var DetailsPetView = {
	oninit: DetailsPet.loadList,
	view: function() {
		return m('div', [
			m('div',{class:'title'},"Détails de la pétition"),			
			m('div',{class:'title'},"Détails de la pétition"),
			m('table', {class:'table is-striped'},[
				m('tr', [
					m('th', {width:"20%"}, "Titre"), 
					m('th', {width:"15%"}, "Date de création"),
					m('th', {width:"5%"}, "Auteur"),
					m('th', {width:"40%"}, "Probleme"),
					m('th', {width:"5%"}, "Signatures"),
					m('th', {width:"5%"}, "Tags"),
					m('th', {width:"5%"}, "Etat"),
					m('th', {width:"5%"}, "Signer"),
				]),
				DetailsPet.list.map(function(item) {
					if(item.properties.idAuteur == "U1001" && item.properties.etat == "Ouverte") {
						return m('tr', [
							m('td', m('label', item.properties.titre)),
							m('td', m('label', item.properties.dateC)),
							m('td', m('label', item.properties.idAuteur)),
							m('td', m('label', item.properties.probleme)),
							m('td', m('label', item.properties.nbSignature)),
							m('td', m('label', item.properties.tags)),
							m('td', m('label', item.properties.etat)),
							m('button',{
								class: 'button is-danger is-rounded',
								onclick: function(e) {FermerPet.loadList()}					        	
							},"Fermer"),		    		    
						])				    			    				    						    		
					} else if (!(item.properties.idSignataire.includes("U1001")) && item.properties.etat == "Ouverte") {					
						return m('tr', [	
							m('td', m('label', item.properties.titre)),
							m('td', m('label', item.properties.dateC)),
							m('td', m('label', item.properties.idAuteur)),
							m('td', m('label', item.properties.probleme)),
							m('td', m('label', item.properties.nbSignature)),
							m('td', m('label', item.properties.tags)),
							m('td', m('label', item.properties.etat)),
							m('button',{
								class: 'button is-primary is-rounded',
								onclick: function(e) {SignerPet.loadList()}					        	
							},"Signer"),		    		    
						])
					} else {				    		
						return m('tr', [	
							m('td', m('label', item.properties.titre)),
							m('td', m('label', item.properties.dateC)),
							m('td', m('label', item.properties.idAuteur)),
							m('td', m('label', item.properties.probleme)),
							m('td', m('label', item.properties.nbSignature)),
							m('td', m('label', item.properties.tags)),
							m('td', m('label', item.properties.etat)),
							m('td', m('label', {style: {color: "red"}}, "Impossible")),				    		    				        		
						])		
					}				  				   			       			        				     
				})
			])
		])
	}
}

function onSignIn(googleUser) {
    // Useful data for your client-side scripts:
      var profile = googleUser.getBasicProfile();
      Profile.email=profile.getEmail();
      console.log("user signed in");
      DetailsPetView;
	
  }

function signOut() {
    var auth2 = gapi.auth2.getAuthInstance();
    console.log(Profile.email);
    auth2.signOut().then(function () {
      Profile.email="";
      console.log('User signed out.');
      console.log(Profile.email);
    });
}



var Hello = {
	view: function() {
		return m('div', {class:'container'}, [
				m("div", {	
					   "style": "display:none",
			      	   "class":"g-signin2",
			      	   "data-theme":"dark",
			      	   "data-onsuccess": "onSignIn"}),  	   
			m('nav',{class: 'navbar is-fixed-top'},[
				m('div',{class: 'navbar-start'},[
					m("site", {class: 'title'}, 'TinyPet'),
					m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/index.html";}},
						m("icon", {class:"fas fa-chart-line"}), "Top Petition"),
					m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/creerPetition.html";}}, 
						m("icon", {class:"fas fa-pen"}), "Créer petition"),
					m('button', {class:"button is-link is-light is-rounded", onclick: function(e) { document.location.href="/espacePerso.html";}}, 
						m("icon", {class:"fas fa-user"}), "Espace perso"),
				]),
				m('div',{class: 'navbar-end'},[
					m('button', {class:"button is-warning is-rounded", onclick: function(e) { javascript:history.back();}},
						m("icon", {class:"fas fa-undo"}), "Retour"),
					m('button', {class:"button is-danger is-rounded", onclick: function(e) { signOut();}},
						m("icon", {class:"fas fa-sign-out-alt"}), "Deconnexion"),
				]),
			]),
			m("h1", {class: 'title is-ancestor'}, 'Détails de la pétition'),
			m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(DetailsPetView))),
			m("footer", {class: 'has-text-centered'}, "Site réalisé par Luca GARIC et Michaël LOPES - V1.0")
		])
		
	}
	
}

m.mount(document.body, Hello)
</script>
</body>
</html>