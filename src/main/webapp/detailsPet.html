<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Top petitions</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script src="https://unpkg.com/mithril/mithril.js"></script>

</head>
<body>

<script>

var currenturl = document.location.href
var idobj = currenturl.split('?')[1]
var idurl = "_ah/api/myApi/v1/detailpet/"+idobj
var idsignerpeturl = "_ah/api/myApi/v1/signerpet/"+idobj
var idfermerpeturl = "_ah/api/myApi/v1/fermerpet/"+idobj

var DetailsPet = {
	    list: [],   
	    loadList: function(idobj) {
	        return m.request({
	        	method: "GET", 
	            url: idurl
	        })
	        .then(function(result) {
	            DetailsPet.list = result.items
	        	console.log("got:",result.items)
	        	// m.redraw(true) 
	        })
	    }
}

var SignerPet = {
	    list: [],   
	    loadList: function(idobj) {
	        return m.request({
	        	method: "GET", 
	            url: idsignerpeturl
	        })
	        .then(function(result) {
	            DetailsPet.list = result.items
	        	console.log("got:",result.items)
	        	DetailsPet.loadList()
	        	// m.redraw(true) 
	        })
	    }
}

var FermerPet = {
    list: [],   
    loadList: function(idobj) {
        return m.request({
        	method: "GET", 
            url: idfermerpeturl
        })
        .then(function(result) {
            DetailsPet.list = result.items
        	console.log("got:",result.items)
        	DetailsPet.loadList()
        	// m.redraw(true) 
        })
    }
}

var DetailsPetView = {
		  oninit: DetailsPet.loadList,
		  view: function() {
		   	return m('div', [
			  m('div',{class:'subtitle'},"Détails de cette pétition"),
			  m('table', {class:'table is-striped'},[
			    m('tr', [
			      m('th', {width:"20%"}, "Titre"), 
			      m('th', {width:"15%"}, "Date de création"),
			      m('th', {width:"5%"}, "Auteur"),
			      m('th', {width:"40%"}, "Probleme"),
			      m('th', {width:"5%"}, "Signatures"),
			      m('th', {width:"5%"}, "Tags"),
			      m('th', {width:"5%"}, "Etat"),
			      m('th', {width:"5%"}, "Signer"),
			    ]),
			    DetailsPet.list.map(function(item) {			  			      			   
		    		if(item.properties.idAuteur == "U1001" && item.properties.etat == "Ouverte"){
				    	return m('tr', [	
			    			m('td', m('label', item.properties.titre)),
			    		    m('td', m('label', item.properties.dateC)),
			    		    m('td', m('label', item.properties.idAuteur)),
			    		    m('td', m('label', item.properties.probleme)),
			    		    m('td', m('label', item.properties.nbSignature)),
			    		    m('td', m('label', item.properties.tags)),
			    		    m('td', m('label', item.properties.etat)),
			    		    m('button',{
					        	class: 'button is-link',
					        	onclick: function(e) {FermerPet.loadList()}					        	
					        },"Fermer"),		    		    
					     ])				    			    				    						    		
			   		 }else if (!(item.properties.idSignataire.includes("U1001")) && item.properties.etat == "Ouverte"){
			    	 	return m('tr', [	
				    		m('td', m('label', item.properties.titre)),
			    		    m('td', m('label', item.properties.dateC)),
			    		    m('td', m('label', item.properties.idAuteur)),
			    		    m('td', m('label', item.properties.probleme)),
			    		    m('td', m('label', item.properties.nbSignature)),
			    		    m('td', m('label', item.properties.tags)),
			    		    m('td', m('label', item.properties.etat)),
			    		    m('button',{
					        	class: 'button is-link',
					        	onclick: function(e) {SignerPet.loadList()}					        	
					        },"Signer"),		    		    
				    	 ])
			    	}else{				    		
				    	 return m('tr', [	
				    			m('td', m('label', item.properties.titre)),
				    		    m('td', m('label', item.properties.dateC)),
				    		    m('td', m('label', item.properties.idAuteur)),
				    		    m('td', m('label', item.properties.probleme)),
				    		    m('td', m('label', item.properties.nbSignature)),
				    		    m('td', m('label', item.properties.tags)),
				    		    m('td', m('label', item.properties.etat)),
				    		    m('td', m('label', {style: {color: "red"}}, "Impossible")),				    		    				        		
				        ])		
			    	}				  				   			       			        				     
			    })			   
			 ])
		])
	}
}

var Hello = {
   view: function() {
	   return m('div', {class:'container'}, [
           m("h1", {class: 'title'}, 'Détails de la pétition'),
           m('div',{class: 'tile is-ancestor'},[
               m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(DetailsPetView))),
           ])         
       ])
   }
}
m.mount(document.body, Hello)
</script>
</body>
</html>